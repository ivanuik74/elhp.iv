<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Публичная лента</title>
<style>
body {margin:0;font-family:'Segoe UI',sans-serif;background:#111;color:#fff;height:100vh;display:flex;flex-direction:column;}
#loginDiv{display:flex;flex-direction:column;justify-content:center;align-items:center;flex:1;}
input,button{padding:10px;border-radius:6px;border:none;margin:5px 0;width:90%;max-width:300px;background:#222;color:#fff;}
button{cursor:pointer;background:#444;}
button:hover{background:#555;}

#chatDiv{display:none;flex:1;flex-direction:column;height:100%;}
#chatTitle{background:#222;padding:10px;text-align:center;font-weight:bold;border-bottom:1px solid #333;}
#messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;}
.message{max-width:70%;margin:5px 0;padding:10px;border-radius:15px;background:#222;word-break:break-word;}
.message.you{background:#333;align-self:flex-end;}
.message .id{font-weight:bold;color:#aaa;margin-right:5px;}

#inputArea{display:flex;padding:5px;background:#222;}
#textInput{flex:1;padding:10px;border:none;border-radius:6px;background:#333;color:#fff;margin-right:5px;}
#sendBtn{padding:10px 20px;border:none;border-radius:6px;background:#444;cursor:pointer;}

@media(max-width:600px){
#messages{padding:5px;}
#textInput{font-size:16px;}
#sendBtn{font-size:16px;}
}
</style>
</head>
<body>

<div id="loginDiv">
<h2>Выбери ник (A-Z, a-z, цифры, _)</h2>
<input type="text" id="nickname" placeholder="Ник">
<button id="loginBtn">Войти</button>
</div>

<div id="chatDiv">
<div id="chatTitle">#Лента</div>
<div id="messages"></div>
<div id="inputArea">
<input type="text" id="textInput" placeholder="Напишите сообщение...">
<button id="sendBtn">Отправить</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// ==== Firebase config ====
const firebaseConfig = {
apiKey: "AIzaSyBnI40Y9ti3bnsgPAYg4G9zaM1J8qkk1z8",
authDomain: "elhp-iv.firebaseapp.com",
projectId: "elhp-iv",
storageBucket: "elhp-iv.firebasestorage.app",
messagingSenderId: "457553204800",
appId: "1:457553204800:web:a9ae88735115a76c66b1a5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
let messagesDiv = document.getElementById("messages");

// Проверка ника
function isValidNick(nick){ return /^[A-Za-z0-9_]{3,20}$/.test(nick); }

// Проверка localStorage
let storedNick = localStorage.getItem("nickname");
if(storedNick){ currentUser = { nickname: storedNick }; showChat(); }

// Вход / регистрация
document.getElementById("loginBtn").addEventListener("click", ()=>{
let nick = document.getElementById("nickname").value.trim();
if(!isValidNick(nick)) return alert("Ник 3-20 символов, A-Z, a-z, цифры, _");
currentUser = { nickname: nick };
localStorage.setItem("nickname", nick);
showChat();
});

// Показ чата и запуск слушателя сообщений
function showChat(){
document.getElementById("loginDiv").style.display = "none";
document.getElementById("chatDiv").style.display = "flex";
startListeningMessages();
}

// Слушатель сообщений
function startListeningMessages(){
db.collection("messages")
.orderBy("timestamp")
.onSnapshot(snapshot=>{
messagesDiv.innerHTML = "";
snapshot.forEach(doc=>{
const msg = doc.data();
if(msg.participants && msg.participants.includes("#Лента")){
appendMessage(msg);
}
});
messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
}

// Добавление сообщения в DOM
function appendMessage(msg){
const div = document.createElement("div");
div.classList.add("message");
if(msg.sender === currentUser.nickname) div.classList.add("you");
div.innerHTML = `<span class="id">${msg.sender}:</span>${msg.text}`;
messagesDiv.appendChild(div);
}

// Отправка сообщений
document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("textInput").addEventListener("keypress", function(e){
if(e.key==="Enter"){ e.preventDefault(); sendMessage(); }
});

function sendMessage(){
const text = document.getElementById("textInput").value.trim();
if(!text) return;
if(!currentUser) return alert("Введите ник");

db.collection("messages").add({
sender: currentUser.nickname,
participants: ["#Лента"],
text: text,
timestamp: firebase.firestore.FieldValue.serverTimestamp()
}).then(()=>{
document.getElementById("textInput").value = "";
}).catch(err=>{
console.error(err);
alert("Ошибка при отправке");
});
}
</script>
</body>
</html>
