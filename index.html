<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>elhp.iv — Лента</title>

<!-- Стили прямо в HTML -->
<style>
body {
margin:0;
font-family:'Segoe UI',sans-serif;
background:#111;
color:#fff;
display:flex;
flex-direction:column;
height:100vh;
}
#topBar {
display:flex;
align-items:center;
justify-content:space-between;
padding:10px 20px;
background:#222;
border-bottom:1px solid #333;
}
#logo {
font-size:1.5em;
font-weight:bold;
color:#fff;
opacity:0;
animation: fadeInLogo 3s forwards;
}
#authors {
font-size:0.9em;
color:#888;
}
@keyframes fadeInLogo {
0% { opacity:0; transform: translateY(-20px); }
100% { opacity:1; transform: translateY(0); }
}
#loginDiv, #chatDiv { opacity:0; transition: opacity 0.5s ease; }
#loginDiv {
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
flex:1;
}
input, button {
padding:10px;
border-radius:6px;
border:none;
margin:5px 0;
width:90%;
max-width:300px;
background:#222;
color:#fff;
transition: all 0.2s ease;
}
button { cursor:pointer; background:#444; }
button:hover { background:#555; transform: scale(1.03); }
#chatDiv { display:none; flex:1; flex-direction:column; height:100%; }
#chatTitle { background:#222; padding:10px; text-align:center; font-weight:bold; border-bottom:1px solid #333; }
#messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; }
.message { max-width:70%; margin:5px 0; padding:10px; border-radius:15px; background:#222; word-break:break-word; animation: fadeInMsg 0.3s forwards; }
.message.you { background:#333; align-self:flex-end; }
.message .id { font-weight:bold; margin-right:5px; }
@keyframes fadeInMsg { 0% { opacity:0; transform: translateY(10px); } 100% { opacity:1; transform: translateY(0); } }
#inputArea { display:flex; padding:5px; background:#222; }
#textInput { flex:1; padding:10px; border:none; border-radius:6px; background:#333; color:#fff; margin-right:5px; }
#sendBtn { padding:10px 20px; border:none; border-radius:6px; background:#444; cursor:pointer; }
#sendBtn:hover { transform: scale(1.03); }
@media(max-width:600px) {
#messages { padding:5px; }
#textInput, #sendBtn { font-size:16px; }
}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>

<div id="topBar">
<div id="logo">elhp.iv</div>
<div id="authors">Сделано karweqks и ivanuik74</div>
</div>

<div id="loginDiv">
<h2>Выбери ник (A-Z, a-z, цифры, _)</h2>
<input type="text" id="nickname" placeholder="Ник">
<button id="loginBtn">Войти</button>
</div>

<div id="chatDiv">
<div id="chatTitle">#Лента</div>
<div id="messages"></div>
<div id="inputArea">
<input type="text" id="textInput" placeholder="Напишите сообщение...">
<button id="sendBtn">Отправить</button>
</div>
</div>

<script>
// ==== Firebase config ====
const firebaseConfig = {
apiKey: "AIzaSyBnI40Y9ti3bnsgPAYg4G9zaM1J8qkk1z8",
authDomain: "elhp-iv.firebaseapp.com",
projectId: "elhp-iv",
storageBucket: "elhp-iv.firebasestorage.app",
messagingSenderId: "457553204800",
appId: "1:457553204800:web:a9ae88735115a76c66b1a5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
const messagesDiv = document.getElementById("messages");

// ==== Логотип появляется первым ====
document.getElementById("logo").addEventListener("animationend", ()=>{
let storedNick = localStorage.getItem("nickname");
if(storedNick){
db.collection("users").doc(storedNick).get().then(doc=>{
if(doc.exists){
currentUser = { nickname: storedNick, color: doc.data().color };
showChat();
} else { showLogin(); }
});
} else { showLogin(); }
});

// ==== Отображение ====
function showLogin(){
document.getElementById("loginDiv").style.display="flex";
setTimeout(()=>{ document.getElementById("loginDiv").style.opacity=1; },50);
}

function showChat(){
document.getElementById("loginDiv").style.display="none";
const chatDiv = document.getElementById("chatDiv");
chatDiv.style.display="flex";
setTimeout(()=>{ chatDiv.style.opacity=1; },50);
startListeningMessages();
}

// ==== Проверка ника ====
function isValidNick(nick){ return /^[A-Za-z0-9_]{3,20}$/.test(nick); }

// ==== Генерация уникального цвета ====
function getRandomColor(existingColors){
let color;
do { color = `hsl(${Math.floor(Math.random()*360)},70%,60%)`; }
while(existingColors.has(color));
return color;
}

// ==== Регистрация ====
document.getElementById("loginBtn").addEventListener("click", async ()=>{
let nick = document.getElementById("nickname").value.trim();
if(!isValidNick(nick)) return alert("Ник 3-20 символов, A-Z, a-z, цифры, _");

try {
const userRef = db.collection("users").doc(nick);
const doc = await userRef.get();
if(doc.exists) return alert("Такой ник уже занят!");

const usersSnapshot = await db.collection("users").get();
let existingColors = new Set();
usersSnapshot.forEach(d=>{
if(d.data().color) existingColors.add(d.data().color);
});

const color = getRandomColor(existingColors);

await userRef.set({
createdAt: firebase.firestore.FieldValue.serverTimestamp(),
color: color
});

currentUser = { nickname: nick, color: color };
localStorage.setItem("nickname", nick);
showChat();

} catch(err){
console.error(err);
alert("Ошибка при регистрации ника.");
}
});

// ==== Слушаем сообщения ====
function startListeningMessages(){
db.collection("messages").orderBy("timestamp").onSnapshot(snapshot=>{
messagesDiv.innerHTML = "";
snapshot.forEach(doc=>{
const msg = doc.data();
appendMessage(msg);
});
messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
}

// ==== Добавление сообщений ====
function appendMessage(msg){
const div = document.createElement("div");
div.classList.add("message");
if(msg.sender === currentUser.nickname) div.classList.add("you");
const nickColor = msg.color || "#fff";
div.innerHTML = `<span class="id" style="color:${nickColor}">${msg.sender}:</span> ${msg.text}`;
messagesDiv.appendChild(div);
}

// ==== Отправка ====
document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("textInput").addEventListener("keypress", function(e){
if(e.key==="Enter"){ e.preventDefault(); sendMessage(); }
});

function sendMessage(){
const text = document.getElementById("textInput").value.trim();
if(!text) return;
if(!currentUser || !currentUser.nickname) { alert("Введите ник!"); return; }

db.collection("messages").add({
sender: currentUser.nickname,
color: currentUser.color,
text: text,
timestamp: firebase.firestore.FieldValue.serverTimestamp()
}).then(()=>{ document.getElementById("textInput").value = ""; })
.catch(err=>{
console.error("Ошибка при отправке:", err);
alert("Ошибка при отправке сообщения.");
});
}
</script>

</body>
</html>
