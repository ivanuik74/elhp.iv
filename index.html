<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Messenger + Лента</title>
<style>
body {
margin:0; font-family:'Segoe UI', sans-serif; background:#111; color:#fff; height:100vh;
display:flex; flex-direction:column;
}

/* === Логин === */
#loginDiv {
display:flex; flex-direction:column; justify-content:center; align-items:center; flex:1;
}
input, button {
padding:10px; border-radius:6px; border:none; margin:5px 0; width:200px; background:#222; color:#fff;
}
button { cursor:pointer; background:#444; }
button:hover { background:#555; }

/* === Контейнер мессенджера === */
.container {
display:flex; flex:1; height:100%;
}

/* === Sidebar === */
#sidebar {
width:250px; background:#1a1a1a; padding:10px; overflow-y:auto;
}
#sidebar h3 { margin-top:0; }
#searchUser { width:100%; padding:6px; margin-bottom:10px; border-radius:4px; border:none; background:#222; color:#fff; }

/* === Chat area === */
#chatArea {
flex:1; display:flex; flex-direction:column;
}

/* === Navbar с вкладками === */
#navbar {
height:50px; background:#222; display:flex; align-items:center; padding:0 10px;
}
#navbar button {
background:#444; color:#fff; border:none; padding:6px 12px; margin-right:5px; cursor:pointer; border-radius:4px;
}
#navbar button.active { background:#666; }
#chatTitle { font-weight:bold; margin-left:10px; }

/* === Messages === */
#messages {
flex:1; padding:10px; overflow-y:auto;
}
.message {
margin:5px 0; padding:6px 10px; border-radius:6px; background:#222;
}
.message.you { background:#333; text-align:right; }
.message .id { font-weight:bold; color:#aaa; margin-right:6px; }

/* === Input area === */
#inputArea {
display:flex; padding:10px; background:#222;
}
#inputArea input {
flex:1; margin-right:5px; border-radius:6px; border:none; padding:10px; background:#222; color:#fff;
}
#inputArea button {
padding:10px 20px; border:none; border-radius:6px; background:#444; color:#fff; cursor:pointer;
transition:transform 0.1s ease;
}
#inputArea button:active { transform:scale(0.97); }

</style>
</head>
<body>

<!-- Логин -->
<div id="loginDiv">
<h2>Выбери ник</h2>
<input type="text" id="nickname" placeholder="Ник">
<button id="loginBtn">Войти</button>
</div>

<!-- Основной мессенджер -->
<div class="container" id="messengerDiv" style="display:none;">
<div id="sidebar">
<h3>Чаты</h3>
<input type="text" id="searchUser" placeholder="Найти пользователя...">
<div id="searchResults"></div>
</div>
<div id="chatArea">
<div id="navbar">
<button id="tabChats" class="active">Чаты</button>
<button id="tabFeed">Лента</button>
<span id="chatTitle">Выберите чат</span>
</div>
<div id="messages"></div>
<div id="inputArea">
<input type="text" id="textInput" placeholder="Напишите сообщение...">
<button id="sendBtn">Отправить</button>
</div>
</div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// === Firebase config ===
const firebaseConfig = {
apiKey: "AIzaSyBnI40Y9ti3bnsgPAYg4G9zaM1J8qkk1z8",
authDomain: "elhp-iv.firebaseapp.com",
projectId: "elhp-iv",
storageBucket: "elhp-iv.firebasestorage.app",
messagingSenderId: "457553204800",
appId: "1:457553204800:web:a9ae88735115a76c66b1a5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
let currentChat = null;

// === Регистрация / Вход по нику ===
async function login() {
let nick = document.getElementById("nickname").value.trim();
if(!nick) return alert("Ник не может быть пустым!");
nick = nick.replace(/[.#$[\]]/g, "_"); // чистим ник для Firestore

const userRef = db.collection("users").doc(nick);
const doc = await userRef.get();

try {
if(!doc.exists) {
// регистрация
await userRef.set({ nickname: nick, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
}

currentUser = { nickname: nick };
document.getElementById("loginDiv").style.display="none";
document.getElementById("messengerDiv").style.display="flex";

renderChats();
setupSearch();

} catch(err){ console.error(err); alert("Ошибка при входе/регистрации"); }
}
document.getElementById("loginBtn").addEventListener("click", login);

// === Список пользователей (чатов) ===
async function renderChats() {
const chatList = document.getElementById("searchResults");
chatList.innerHTML = "";
const usersSnap = await db.collection("users").get();
usersSnap.forEach(doc=>{
const u = doc.data();
if(u.nickname !== currentUser.nickname) {
const div = document.createElement("div");
div.textContent = u.nickname;
div.style.cursor = "pointer";
div.addEventListener("click", ()=> openPrivateChat(u.nickname));
chatList.appendChild(div);
}
});
}

// === Поиск пользователя ===
function setupSearch() {
const searchInput = document.getElementById("searchUser");
searchInput.addEventListener("input", async function() {
const query = this.value.trim().toLowerCase();
const resultsDiv = document.getElementById("searchResults");
resultsDiv.innerHTML = "";
if(!query) return;
const usersSnap = await db.collection("users").get();
usersSnap.forEach(doc=>{
const u = doc.data();
if(u.nickname.toLowerCase().includes(query) && u.nickname !== currentUser.nickname) {
const div = document.createElement("div");
div.textContent = u.nickname;
div.style.cursor = "pointer";
div.addEventListener("click", ()=> openPrivateChat(u.nickname));
resultsDiv.appendChild(div);
}
});
});
}

// === Открытие приватного чата ===
function openPrivateChat(chatNick) {
currentChat = chatNick;
document.getElementById("chatTitle").textContent = "Чат с: " + chatNick;
sidebar.style.display = "block";
inputArea.style.display = "flex";
tabChats.classList.add("active");
tabFeed.classList.remove("active");
renderPrivateMessages();
}

// === Отображение приватных сообщений ===
function renderPrivateMessages() {
const messagesDiv = document.getElementById("messages");
messagesDiv.innerHTML = "";
if(!currentChat) return;

db.collection("messages")
.where("participants", "array-contains", currentUser.nickname)
.orderBy("timestamp")
.onSnapshot(snapshot=>{
messagesDiv.innerHTML = "";
snapshot.forEach(doc=>{
const msg = doc.data();
if(msg.participants.includes(currentChat)) {
const div = document.createElement("div");
div.classList.add("message");
if(msg.sender === currentUser.nickname) div.classList.add("you");
div.innerHTML = `<span class="id">${msg.sender}:</span>${msg.text}`;
messagesDiv.appendChild(div);
}
});
messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
}

// === Отправка приватного сообщения ===
document.getElementById("sendBtn").addEventListener("click", async ()=>{
const text = document.getElementById("textInput").value.trim();
if(!text || !currentChat) return;
await db.collection("messages").add({
sender: currentUser.nickname,
participants: [currentUser.nickname, currentChat],
text: text,
timestamp: firebase.firestore.FieldValue.serverTimestamp()
});
document.getElementById("textInput").value="";
});

// === Вкладки Чаты / Лента ===
const tabChats = document.getElementById("tabChats");
const tabFeed = document.getElementById("tabFeed");
const sidebar = document.getElementById("sidebar");
const inputArea = document.getElementById("inputArea");
const chatTitle = document.getElementById("chatTitle");

tabChats.addEventListener("click", ()=>{
sidebar.style.display="block";
inputArea.style.display="flex";
chatTitle.textContent = currentChat ? "Чат с: "+currentChat : "Выберите чат";
tabChats.classList.add("active");
tabFeed.classList.remove("active");
renderPrivateMessages();
});

tabFeed.addEventListener("click", ()=>{
sidebar.style.display="none";
inputArea.style.display="none";
chatTitle.textContent = "Лента всех сообщений";
tabChats.classList.remove("active");
tabFeed.classList.add("active");
renderFeed();
});

// === Лента всех сообщений (публичные) ===
function renderFeed(){
const messagesDiv = document.getElementById("messages");
messagesDiv.innerHTML = "";

db.collection("messages").orderBy("timestamp")
.onSnapshot(snapshot=>{
messagesDiv.innerHTML = "";
snapshot.forEach(doc=>{
const msg = doc.data();
const div = document.createElement("div");
div.classList.add("message");
div.innerHTML = `<span class="id">${msg.sender}:</span>${msg.text}`;
messagesDiv.appendChild(div);
});
messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
}

// === Отправка по Enter ===
document.getElementById("textInput").addEventListener("keypress", function(e){
if(e.key === "Enter") { e.preventDefault(); document.getElementById("sendBtn").click(); }
});
</script>
</body>
</html>
