<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Messenger</title>
<style>
body {
margin:0; font-family:'Segoe UI', sans-serif; background:#111; color:#fff; height:100vh; display:flex; flex-direction:column;
}
#loginDiv { display:flex; flex-direction:column; justify-content:center; align-items:center; flex:1; }
input, button { padding:10px; border-radius:6px; border:none; margin:5px 0; width:90%; max-width:300px; background:#222; color:#fff; }
button { cursor:pointer; background:#444; }
button:hover { background:#555; }

/* Messenger */
#messengerDiv { display:none; flex:1; display:flex; flex-direction:row; height:100%; }
#sidebar { width:300px; background:#1a1a1a; display:flex; flex-direction:column; }
#searchUser { padding:8px; border:none; border-radius:6px; background:#333; color:#fff; margin:8px; width:calc(100% - 16px); }
#chatList { flex:1; overflow-y:auto; }
.chatItem { padding:10px; border-bottom:1px solid #333; cursor:pointer; }
.chatItem:hover { background:#333; }

#chatArea { flex:1; display:flex; flex-direction:column; }
#chatTitle { height:50px; background:#222; display:flex; align-items:center; justify-content:center; font-weight:bold; border-bottom:1px solid #333; }
#messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; }
.message { max-width:70%; margin:5px 0; padding:10px; border-radius:15px; background:#222; word-break:break-word; }
.message.you { background:#333; align-self:flex-end; }
.message .id { font-weight:bold; color:#aaa; margin-right:5px; }

#inputArea { display:flex; padding:5px; background:#222; }
#textInput { flex:1; padding:10px; border:none; border-radius:6px; background:#333; color:#fff; margin-right:5px; }
#sendBtn { padding:10px 20px; border:none; border-radius:6px; background:#444; cursor:pointer; }

@media(max-width:600px){
#messengerDiv { flex-direction:column; }
#sidebar { width:100%; flex:0 0 auto; order:1; }
#chatArea { flex:1; order:2; }
}
</style>
</head>
<body>

<div id="loginDiv">
<h2>Выбери ник (A-Z, a-z, цифры, _)</h2>
<input type="text" id="nickname" placeholder="Ник">
<button id="loginBtn">Войти / Зарегистрироваться</button>
</div>

<div id="messengerDiv">
<div id="sidebar">
<input type="text" id="searchUser" placeholder="Поиск пользователей...">
<div id="chatList"></div>
</div>
<div id="chatArea">
<div id="chatTitle">Выберите чат</div>
<div id="messages"></div>
<div id="inputArea">
<input type="text" id="textInput" placeholder="Напишите сообщение...">
<button id="sendBtn">Отправить</button>
</div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// === Firebase config ===
const firebaseConfig = {
apiKey: "AIzaSyBnI40Y9ti3bnsgPAYg4G9zaM1J8qkk1z8",
authDomain: "elhp-iv.firebaseapp.com",
projectId: "elhp-iv",
storageBucket: "elhp-iv.firebasestorage.app",
messagingSenderId: "457553204800",
appId: "1:457553204800:web:a9ae88735115a76c66b1a5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
let currentChat = null;

let storedNick = localStorage.getItem("nickname");
if(storedNick){
currentUser = { nickname: storedNick };
document.getElementById("loginDiv").style.display="none";
document.getElementById("messengerDiv").style.display="flex";
renderChats();
}

// Проверка ника
function isValidNick(nick){
return /^[A-Za-z0-9_]{3,20}$/.test(nick);
}

// Вход / Регистрация
document.getElementById("loginBtn").addEventListener("click", async ()=>{
let nick = document.getElementById("nickname").value.trim();
if(!isValidNick(nick)) return alert("Ник 3-20 символов, A-Z, a-z, цифры, _");

const userRef = db.collection("users").doc(nick);
const doc = await userRef.get();

try{
if(doc.exists){
alert("Ник уже занят!");
return;
}
await userRef.set({ nickname:nick, createdAt:firebase.firestore.FieldValue.serverTimestamp() });
currentUser = { nickname:nick };
localStorage.setItem("nickname", nick);
document.getElementById("loginDiv").style.display="none";
document.getElementById("messengerDiv").style.display="flex";
renderChats();
}catch(err){ console.error(err); alert("Ошибка при регистрации"); }
});

// Список чатов
const chatListDiv = document.getElementById("chatList");
async function renderChats(){
chatListDiv.innerHTML="";
const usersSnap = await db.collection("users").get();
usersSnap.forEach(doc=>{
const u = doc.data();
if(u.nickname!==currentUser.nickname){
const div = document.createElement("div");
div.classList.add("chatItem");
div.textContent = u.nickname;
div.addEventListener("click", ()=> openChat(u.nickname));
chatListDiv.appendChild(div);
}
});
// Публичный чат #Лента
const feedDiv = document.createElement("div");
feedDiv.classList.add("chatItem");
feedDiv.textContent = "#Лента";
feedDiv.style.fontWeight="bold";
feedDiv.addEventListener("click", ()=> openChat("#Лента"));
chatListDiv.prepend(feedDiv);
}

// Поиск
document.getElementById("searchUser").addEventListener("input", async function(){
const query = this.value.trim().toLowerCase();
chatListDiv.innerHTML="";
if(!query) return renderChats();
const usersSnap = await db.collection("users").get();
usersSnap.forEach(doc=>{
const u = doc.data();
if(u.nickname.toLowerCase().includes(query) && u.nickname!==currentUser.nickname){
const div = document.createElement("div");
div.classList.add("chatItem");
div.textContent = u.nickname;
div.addEventListener("click", ()=> openChat(u.nickname));
chatListDiv.appendChild(div);
}
});
});

// Открытие чата
const messagesDiv = document.getElementById("messages");
const chatTitle = document.getElementById("chatTitle");
function openChat(nick){
currentChat = nick;
chatTitle.textContent = nick;
renderMessages();
}

// Отображение сообщений
function renderMessages(){
if(!currentChat) return;
messagesDiv.innerHTML="";
db.collection("messages")
.orderBy("timestamp")
.onSnapshot(snapshot=>{
messagesDiv.innerHTML="";
snapshot.forEach(doc=>{
const msg = doc.data();

if(currentChat==="#Лента" && msg.participants.includes("#Лента")){
appendMessage(msg);
} else if(currentChat!=="#Лента" &&
msg.participants.includes(currentChat) &&
msg.participants.includes(currentUser.nickname)){
appendMessage(msg);
}
});
messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
}

// Добавление сообщения в DOM
function appendMessage(msg){
const div = document.createElement("div");
div.classList.add("message");
if(msg.sender===currentUser.nickname) div.classList.add("you");
div.innerHTML = `<span class="id">${msg.sender}:</span>${msg.text}`;
messagesDiv.appendChild(div);
}

// Отправка сообщения
document.getElementById("sendBtn").addEventListener("click", async ()=>{
const text = document.getElementById("textInput").value.trim();
if(!text) return;
if(!currentChat) return alert("Выберите чат");

let participants = currentChat==="#Лента" ? ["#Лента"] : [currentUser.nickname,currentChat];

try{
await db.collection("messages").add({
sender: currentUser.nickname,
participants: participants,
text:text,
timestamp:firebase.firestore.FieldValue.serverTimestamp()
});
document.getElementById("textInput").value="";
}catch(err){ console.error(err); alert("Ошибка при отправке"); }
});

// Enter для отправки
document.getElementById("textInput").addEventListener("keypress", function(e){
if(e.key==="Enter"){ e.preventDefault(); document.getElementById("sendBtn").click(); }
});
</script>
</body>
</html>
